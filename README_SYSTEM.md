# PCB Stitching & Quality Assessment System
## Complete Integration Guide & Documentation

---

## System Overview

Unified system for PCB tile stitching and automatic quality assessment consisting of:

```
┌─────────────────────────────────────────────────────────────────┐
│                    PCB STITCHING PIPELINE                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  INPUT: Tile Images → [STITCH] → Stitched Image                 │
│                                      ↓                           │
│                           [EVALUATE] → Metrics (PSNR, SSIM, IOU) │
│                                      ↓                           │
│           [MODEL PREDICT] → Quality Classification               │
│           (Good/Fair/Poor)        ↓                              │
│                           [GENERATE ADVICE] → Recommendations    │
│                                      ↓                           │
│           OUTPUT: Reports, Visualizations, Predictions          │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## Key Components

### 1. Stitching Engine (stitch_tiles.py)
- **Algorithm**: SIFT feature matching + Homography estimation
- **Input**: Tile directory
- **Output**: Stitched panorama image
- **Features**: Handles rotations, automatic alignment

### 2. Evaluation Module (evaluation.py)
- **Metrics Computed**:
  - PSNR (Peak Signal-to-Noise Ratio)
  - SSIM (Structural Similarity Index)
  - Edge IOU (Intersection over Union on edges)
- **Inputs**: Stitched image + Ground truth image
- **Output**: CSV with metrics for each image variant

### 3. ML Classification Model (train_balanced_model.py)
- **Model**: LightGBM Classifier
- **Classes**: Good (25%), Fair (50%), Poor (25%)
- **Features**: 6 quantitative metrics
- **Accuracy**: 99.17% (balanced)
- **Thresholds**: Based on natural quantiles of PSNR_FINAL

### 4. Advice Generation (run_model_advice.py)
- **Input**: Predictions from model
- **Output**: Actionable advice for each sample
- **Includes**: Quality level + specific recommendations

---

## Model Performance Summary

| Metric | Value |
|--------|-------|
| **Overall Accuracy** | 99.17% |
| **Fair Precision** | 99% |
| **Fair Recall** | 97% |
| **Good Precision** | 100% |
| **Good Recall** | 100% |
| **Poor Precision** | 95% |
| **Poor Recall** | 100% |

**Quality Thresholds (PSNR_FINAL):**
- Poor: < 12.14 (Bottom 25%)
- Fair: 12.14 - 15.36 (Middle 50%)
- Good: ≥ 15.36 (Top 25%)

---

## Using the Unified Pipeline

### Basic Usage

```bash
cd D:\Dataset_PCB_Final

# Run complete pipeline
python.exe scripts/unified_pipeline.py ^
  --tiles_dir "path\to\tiles" ^
  --gt_dir "path\to\ground_truth" ^
  --output_dir "path\to\output"
```

### With JSON Output (for programmatic access)

```bash
python.exe scripts/pipeline_cli.py ^
  --tiles "path\to\tiles" ^
  --gt "path\to\ground_truth" ^
  --output "path\to\output" ^
  --json
```

### Options

```bash
--tiles_dir         Input tiles directory (required)
--gt_dir            Ground truth directory (required)
--output_dir        Output directory (default: results/pipeline_output)
--nfeatures         Number of SIFT features (default: 5000)
--skip_stitch       Skip stitching step
--skip_eval         Skip evaluation step
--json              Output as JSON (CLI only)
```

---

## Integration with C# Application

### Example Code

```csharp
using System;
using System.Diagnostics;

class PCBIntegration
{
    public static void RunPipeline(string tilesDir, string gtDir)
    {
        var psi = new ProcessStartInfo
        {
            FileName = @"D:\Dataset_PCB_Final\.venv\Scripts\python.exe",
            Arguments = $@"scripts\pipeline_cli.py " +
                       $@"--tiles ""{tilesDir}"" " +
                       $@"--gt ""{gtDir}"" " +
                       $@"--json",
            UseShellExecute = false,
            RedirectStandardOutput = true,
            CreateNoWindow = true
        };
        
        using (var process = Process.Start(psi))
        {
            string json = process.StandardOutput.ReadToEnd();
            process.WaitForExit();
            
            // Parse JSON and handle result
            dynamic result = JsonConvert.DeserializeObject(json);
            
            if (result.success)
            {
                MessageBox.Show("Pipeline completed successfully!");
            }
            else
            {
                MessageBox.Show($"Error: {result.stderr}");
            }
        }
    }
}
```

---

## Output Files

### Generated by Pipeline

```
results/
├── advice_model/
│   ├── lgb_model_balanced.joblib          Model (733KB)
│   ├── feature_scaler_balanced.joblib     Scaler
│   ├── label_encoder_balanced.joblib      Encoder
│   ├── predictions_with_advice.csv        All predictions with advice
│   ├── confusion_matrix_balanced_01.png   Classic heatmap visualization
│   ├── confusion_matrix_balanced_02.png   Normalized percentage visualization
│   ├── confusion_matrix_balanced_03.png   Dual (count + percentage)
│   ├── confusion_matrix_balanced_04.png   Matrix with metrics panel
│   ├── MODEL_REPORT.txt                   Comprehensive analysis
│   └── MODEL_METRICS.csv                  Key metrics in CSV
├── pipeline_output/
│   ├── stitched/                          Stitched images
│   ├── PIPELINE_SUMMARY.json              Execution summary
│   └── ALL_METRICS.csv                    Raw evaluation metrics
└── evaluation/
    └── [variant_folders]/                 Per-variant metrics
```

### Key Output Files for Reports

1. **MODEL_METRICS.csv** - Numbers for tables
   - Accuracy, Precision, Recall, F1-Score
   - PSNR/SSIM/IOU statistics
   - Quality thresholds

2. **MODEL_REPORT.txt** - Detailed narrative report
   - Dataset information
   - Model performance analysis
   - Per-class metrics
   - Feature importance ranking

3. **Confusion Matrix PNGs** - Visualizations
   - 4 different styles for presentations
   - High resolution (300 DPI)

4. **predictions_with_advice.csv** - Sample predictions
   - Every image's quality classification
   - Confidence scores
   - Actionable advice text

---

## Feature Importance Ranking

| Rank | Feature | Importance | Interpretation |
|------|---------|-----------|-----------------|
| 1 | PSNR_FINAL | 1872 | Final image quality metrics most important |
| 2 | IOU_STITCH | 946 | Edge detection after stitching |
| 3 | IOU_FINAL | 828 | Final edge matching quality |
| 4 | SSIM_FINAL | 644 | Structural similarity critical |
| 5 | SSIM_STITCH | 588 | SSIM during stitching process |
| 6 | PSNR_STITCH | 498 | Initial PSNR less important |

---

## Data Statistics

**Dataset Size**: 399 samples across multiple PCB variants

**Quality Distribution (after classification)**:
- Poor Quality: 100 samples (25.1%) - PSNR < 12.14
- Fair Quality: 199 samples (49.9%) - 12.14 ≤ PSNR < 15.36
- Good Quality: 100 samples (25.1%) - PSNR ≥ 15.36

**Image Metrics Ranges**:
- PSNR_FINAL: 9.14 - 18.76 (mean: 13.82, std: 2.13)
- SSIM_FINAL: 0.242 - 0.824 (mean: 0.539, std: 0.126)
- IOU_FINAL: 0.090 - 0.623 (mean: 0.362, std: 0.111)

---

## Troubleshooting

### Common Issues & Solutions

| Issue | Cause | Solution |
|-------|-------|----------|
| Python not found | Virtualenv not activated | Run `.venv\Scripts\activate` |
| Tiles not found | Wrong path format | Check: `tiles\mach1\variant\case\type` |
| GT directory not found | Missing ground truth | Ensure canonical files exist |
| Out of memory | Processing too many features | Reduce `--nfeatures` to 2000 |
| Slow performance | High feature count | Use `--nfeatures 2000` for speed |
| Model failed | Missing model file | Check `advice_model/lgb_model_balanced.joblib` |

---

## File Structure

```
D:\Dataset_PCB_Final\
├── .venv/                           Python virtual environment
├── scripts/
│   ├── unified_pipeline.py          Main pipeline (recommended)
│   ├── pipeline_cli.py              CLI wrapper for integration
│   ├── stitching/
│   │   └── stitch_tiles.py          Tile stitching engine
│   └── evaluation/
│       ├── evaluation.py            Metrics computation
│       ├── run_model_advice.py      Prediction with advice
│       ├── train_balanced_model.py  Model training
│       └── generate_report.py       Report generation
├── tiles/
│   ├── mach1/
│   │   ├── mach1_good/
│   │   └── mach1_dazzled/
│   └── mach2/
├── canonical/
│   ├── mach1_gt/                    Ground truth images
│   └── mach2_gt/
├── results/
│   ├── advice_model/                (11 key files for reports)
│   ├── pipeline_output/             (Pipeline execution results)
│   └── evaluation/                  (Detailed metrics per variant)
├── QUICK_START_GUIDE.md             This file
├── INTEGRATION_GUIDE.md             C# integration examples
└── README.md                        General documentation
```

---

## Report Integration Checklist

- [ ] Copy `MODEL_METRICS.csv` for results table
- [ ] Include confusion matrix PNG in results section
- [ ] Reference accuracy from `MODEL_REPORT.txt`
- [ ] Cite feature importance rankings
- [ ] Include sample predictions from `predictions_with_advice.csv`
- [ ] Mention model configuration (LightGBM, 200 estimators)
- [ ] Note quality thresholds based on natural quantiles
- [ ] Reference confusion matrix for detailed breakdown

---

## Next Steps

1. **For Testing**: Run `pipeline_cli.py --help` to see options
2. **For Integration**: See `INTEGRATION_GUIDE.md` for C# code examples
3. **For Details**: Read `results/advice_model/MODEL_REPORT.txt`
4. **For Visualization**: View `confusion_matrix_balanced_*.png` images

---

**Generated**: December 25, 2025
**System**: PCB Stitching & Quality Assessment v1.0
**Status**: Ready for production deployment ✓
